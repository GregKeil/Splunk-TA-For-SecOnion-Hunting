<form version="1.1" theme="dark" onunloadCancelJobs="true">
  <label>Suricata Alert Overview (V5.9.5)</label>
  <description>V5 Additions: Dashboard Now Integrates Drilldown</description>
  <search id="MainBaseSearch">
    <query>| tstats summariesonly=f count from datamodel=Suricata_Suite.alerts by alerts.severity, alerts.signature, alerts.category, alerts.src_ip, alerts.src_port, alerts.dest_ip, alerts.dest_port, alerts.proto, alerts.sid, alerts.community_id, alerts.payload_printable, _time
| rename alerts.severity AS severity, alerts.signature AS signature, alerts.category AS category, alerts.src_ip AS src_ip, alerts.src_port AS src_port, alerts.dest_ip AS dest_ip, alerts.dest_port AS dest_port, alerts.proto AS proto, alerts.sid AS SID, alerts.community_id AS community_id, alerts.payload_printable AS payload_printable
| table severity, signature, category, src_ip, src_port, dest_ip, dest_port, proto, SID, community_id, payload_printable, _time

```Filter Out Specific Rules Here```
| where NOT (
    SID IN ("2008116", "2008120", "2101413", "2101411", "2001219", "2029340", "2003068", "2031071", "2033078", "2100371", "2027766", "2016149", "2100366", "2016870", "2022371", "2018489", "2022547", "2103276", "2102251", "2027758", "2025703", "2019401", "2030917", "2100518", "2013933", "2027757", "2026850", "2026849", "2100227", "2033077", "2027203", "2035090", "2035089", "2012888", "2033355", "2035026", "2029994", "2015744", "2035465", "2027397", "2000334", "2035466", "2048555", "2045757")
    OR like(signature, "ET SCAN%")
    OR like(signature, "ET INFO External IP%")
    OR like(payload_printable, "%nessus%")
    OR like(payload_printable, "%Nmap%")
    OR like(payload_printable, "%f.s.t.m.p%")
    OR like(payload_printable, "%f.s._.a.c.t.i.o.n%")
    OR like(payload_printable, "%f.s.p.r.o.c.s.v.c%")
    OR like(payload_printable, "%S.C.C.M.C.o.n.t.e.n.t.L.i.b%")
    OR like(payload_printable, "%NIC_Power_Management_Discovery.ps1%")
    OR like(payload_printable, "%S.C.C.M.\%")
    OR like(payload_printable, "%c.c.m.c.a.c.h.e.\%")
)

```Payload Filtering Goes Here```
| where NOT (

(like(src_ip, "137.232.%") AND (
    like(payload_printable, "%S.y.s.m.o.n%%") OR
    like(payload_printable, "%S.Y.S.M.O.N%")))

OR (like(signature, "ET INFO SMB2 NT Create AndX Request For an Executable File") AND (
    like(payload_printable, "%SMB@%m.e.t.a.d.a.t.a...i.n.i%")))
    
OR (like(signature, "ET INFO SMB Executable File Transfer") AND (
    like(payload_printable, "%SMB@%L.TKL.TKL.TKk-)K\.TKk-:KR.TKk-9K..TK...KO.TKL.UK..TKk-%KM.TKk-,KM.TKRichL.TK%") OR
    like(payload_printable, "%SMB@%U.#~4.p~4.p~4.pY..pw4.pY..pF4.pY..p.4.p...pm4.p~4.p.4.pY..pr4.pY..p.4.pY..p.4.pRich~4.p%") OR
    like(payload_printable, "%SMB@%0..o0..o0..o.I.o%..o.I.oB..o.I.o;..o0..o...o.I.oa..o.I.o1..o.I.o1..oRich0..o%") OR
    like(payload_printable, "%SMB@%q.R.q.R.q.R.%.V.U.R.%.Q.S.R.%.W...R.%.S.x.R.q.S.S.R.%.[.;.R.%...p.R.%.P.p.R.Richq.R%") OR
    like(payload_printable, "%SMB@%L.%.!.%.7.%.#.%.#.%.+.%.Rich.%.PE%") OR
    like(payload_printable, "%SMB@%m.e.t.a.d.a.t.a...i.n.i%") OR
    like(payload_printable, "%SMB@%&gt;ej._.9._.9._.9._.9._.9. .8._.9. .8._.9. .8=_.9. %8._.9._%9.^.9. .8._.9. .9._.9. .8._.9Rich._.9%"))) 

OR (like(signature, "ET INFO Windows Powershell User-Agent Usage") AND (
    like(payload_printable, "GET /SMS_DP_SMSPKG$/MC000203/exception.sites HTTP/1.1%")))
    
OR (like(signature, "ET INFO WMIC WMI Request Over SMB - Likely Lateral Movement") AND (
    like(payload_printable, "%c:\windows\system32\fsprocsvc.exe fs-execute % fsproc_exec%")))
    
OR (like(signature, "ET INFO Powershell Command With Execution Bypass Argument Over SMB - Likely Lateral Movement") AND (
    like(payload_printable, "%SMB@%C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -Command \"(Get-CimInstance -ClassName Win32_BIOS).SerialNumber\"%") OR
    like(payload_printable, "%SMB@%c:\windows\system32\fsprocsvc.exe fs-execute % fsproc_exec%")))
    
OR (like(signature, "ET INFO PE EXE or DLL Windows file download HTTP") AND (
    like(payload_printable, "%L.%.!.%.7.%.#.%.#.%.+.%.Rich.%.PE%") OR
    !like(payload_printable, "HTTP%"))) ```In place until log parsing issue is fixed```
    
OR (like(signature, "ET INFO SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement") AND (
    like(payload_printable, "%SMB@%q.R.q.R.q.R.%.V.U.R.%.Q.S.R.%.W...R.%.S.x.R.q.S.S.R.%.[.;.R.%...p.R.%.P.p.R.Richq.R%") OR
    like(payload_printable, "%w.i.n.d.o.w.s.\.s.y.s.t.e.m.3.2.\.W.U.A.U.E.N.G...D.L.L.") OR
    like(payload_printable, "%W.I.N.D.O.W.S.\.S.y.s.t.e.m.3.2.\.w.u.a.p.i...d.l.l.")))
    
OR (like(signature, "ET INFO PS1 Powershell File Request") AND (
    like(payload_printable, "%sccm?/%")))

OR (like(signature, "ET INFO SMB2 NT Create AndX Request For a .sys File - Possible Lateral Movement") AND (
    like(payload_printable, "%p.a.g.e.f.i.l.e...s.y.s%")))
)

</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
    <progress>
      <unset token="Loading"></unset>
      <unset token="IPEval"></unset>
      <unset token="HighToLow"></unset>
      <unset token="Formating"></unset>
      <unset token="HighPort"></unset>
    </progress>
    <done>
      <!--Set Your Zeek Indexes -->
      <set token="zeek">zeek*</set>
      <set token="zeeksourcetype">zeek:*:json</set>
      <set token="zeekconnsourcetype">zeek:conn:json</set>
      <!--                      -->
      <set token="IPEval">| eval ExternalSouce = case(
cidrmatch("10.0.0.0/8",src_ip),"False",
cidrmatch("172.16.0.0/12",src_ip),"False",
cidrmatch("192.168.0.0/16",src_ip),"False",
isnull(src_ip) OR like(src_ip,""), "False",
match(src_ip,"^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}$"),"True")

| eval ExternalDest = case(
cidrmatch("10.0.0.0/8",dest_ip),"False",
cidrmatch("172.16.0.0/12",dest_ip),"False",
cidrmatch("192.168.0.0/16",dest_ip),"False",
isnull(dest_ip) OR like(dest_ip,""), "False",
match(dest_ip,"^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}$"),"True")</set>
      <set token="HighToLow">| eval severity = upper(substr(severity,1,1)).lower(substr(severity,2))
| eval sorter=severity
| eval sorter=case(severity="High",1,severity="Medium",2,severity="Low",3)
| sort by sorter,-count
| fields - sorter</set>
      <set token="Formating">| appendpipe [| stats count | where count=0 | eval severity="No Instances Found"]
| rename severity AS Severity, count AS Count, signature AS Signature, category AS Category, src_ip AS Source, dest_ip AS Destination, src_port AS "Source Port", dest_port AS "Destination Port", proto AS Protocol, community_id AS "Community ID"</set>
      <set token="HighPort">| eval src_port=tonumber(src_port)
| eval dest_port=tonumber(dest_port)
| appendpipe [where src_port &gt; 1024 | eval src_port = "High Port"]
| appendpipe [where dest_port &gt; 1024 | eval dest_port = "High Port"]
| mvexpand src_port
| mvexpand dest_port
| where (src_port &lt; tonumber(1025) OR src_port = "High Port") AND (dest_port &lt; tonumber(1025) OR dest_port = "High Port")</set>
      <set token="Loading">1</set>
      <unset token="sid"></unset>
      <unset token="ip"></unset>
      <unset token="cid"></unset>
    </done>
  </search>
  <search id="CompleteBaseSearch">
    <query>| tstats summariesonly=f count from datamodel=Suricata_Suite.alerts by alerts.severity, alerts.signature, alerts.category, alerts.src_ip, alerts.src_port, alerts.dest_ip, alerts.dest_port, alerts.proto, alerts.sid, alerts.community_id, alerts.payload_printable, _time
| rename alerts.severity AS severity, alerts.signature AS signature, alerts.category AS category, alerts.src_ip AS src_ip, alerts.src_port AS src_port, alerts.dest_ip AS dest_ip, alerts.dest_port AS dest_port, alerts.proto AS proto, alerts.sid AS SID, alerts.community_id AS community_id, alerts.payload_printable AS payload_printable
| stats count by severity, signature, category, src_ip, src_port, dest_ip, dest_port, proto, SID, community_id, payload_printable, _time
</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
    <done>
      <set token="ScannerQuery">| stats count by src_ip, scannertype
| fields - count
| mvcombine src_ip
| rename src_ip AS "Scanner IP", scannertype AS "Scanner Type"</set>
      <unset token="sid"></unset>
      <unset token="ip"></unset>
      <unset token="cid"></unset>
      <set token="showscanner">ShowMe</set>
    </done>
  </search>
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time" searchWhenChanged="false">
      <label>Time Selector</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row rejects="$Loading$">
    <panel>
      <html>
      <h1>RESULTS LOADING...</h1>
    </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Total Alerts</title>
      <single>
        <search base="MainBaseSearch">
          <query>| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="link.visible">0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">Excluding Known Scanners</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h3> </h3>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Severity Totals</title>
      <table>
        <search base="MainBaseSearch">
          <query>| stats count by severity
$HighToLow$
$Formating$</query>
        </search>
        <option name="link.visible">false</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="list">[#118832,#FFFFFF]</colorPalette>
          <scale type="threshold">0</scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Unique Signature Totals</title>
      <table>
        <search base="MainBaseSearch">
          <query>| stats count by severity, signature
| stats count by severity
$HighToLow$
$Formating$</query>
        </search>
        <option name="link.visible">false</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="list">[#118832,#FFFFFF]</colorPalette>
          <scale type="threshold">0</scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h3/>
      </html>
    </panel>
  </row>
  <row>
    <panel depends="$showscanner$">
      <title>Scanners Currently Not Be Filtered In Known_Scanners.csv (Pre-Datamodel Ingest)</title>
      <table>
        <search base="CompleteBaseSearch">
          <done>
            <condition match="$job.resultCount$ == 0">
              <unset token="showscanner"></unset>
            </condition>
          </done>
          <query>```Add Scanner Flags And Types Here:```
| appendpipe [| where like (payload_printable, "%nessus%") | eval scannertype="Nessus"]
| appendpipe [| where like (payload_printable, "CCCCCCCCCCCCC%CCCCCCCCCCCCC") OR like (payload_printable, "%Nmap Scripting Engine%")| eval scannertype="Nmap"]

$ScannerQuery$</query>
        </search>
        <option name="drilldown">none</option>
        <option name="link.visible">0</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Scanner Type">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h3> </h3>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Unique Alert Breakdown</title>
      <table>
        <title>Select A SID</title>
        <search base="MainBaseSearch">
          <query>| stats count by severity, signature, category, SID
$HighToLow$
$Formating$</query>
          <done>
            <unset token="ip"></unset>
            <unset token="cid"></unset>
          </done>
        </search>
        <option name="drilldown">cell</option>
        <option name="link.visible">0</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#E3723A,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="count">
          <colorPalette type="list">[#CBA700,#E3723A,#D41F1F]</colorPalette>
          <scale type="threshold">10,100</scale>
        </format>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#D41F1F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <drilldown>
          <set token="sid">$row.SID$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$sid$">
    <panel>
      <html>
        <h2>Current SID Query: $sid$</h2>
        <h3>Select An IP</h3>
      </html>
    </panel>
  </row>
  <row depends="$sid$">
    <panel>
      <table>
        <search base="MainBaseSearch">
          <done>
            <unset token="ip"></unset>
            <unset token="cid"></unset>
          </done>
          <query>| stats count by severity, signature, category, src_ip, src_port, dest_ip, dest_port, proto, SID, community_id, payload_printable, _time
| where like (SID, $sid|s$)
$HighPort$
| stats count by severity, signature, category, SID, src_ip, src_port, dest_ip, dest_port, proto
$HighToLow$
$Formating$</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="link.visible">0</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#D41F1F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <drilldown>
          <set token="ip">$click.value2$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$ip$">
    <panel>
      <html>
        <h2>Current IP Query: $ip$</h2>
        <h3>Select A CommunityID</h3>
      </html>
    </panel>
  </row>
  <row depends="$ip$">
    <panel>
      <table>
        <search base="MainBaseSearch">
          <done>
            <unset token="cid"></unset>
          </done>
          <query>| stats count by severity, signature, category, src_ip, src_port, dest_ip, dest_port, proto, SID, community_id, payload_printable, _time
| where like (src_ip, $ip|s$) OR like (dest_ip, $ip|s$)
$HighPort$
| stats count by severity, signature, category, SID, src_ip, src_port, dest_ip, dest_port, proto, community_id
$HighToLow$
$Formating$</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="link.visible">0</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#D41F1F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <drilldown>
          <set token="cid">$row.Community ID$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$cid$">
    <panel>
      <html>
        <h2>Log Payload Breakdown</h2>
        <h3>Select A Log To Pivot Outside The Dashboard Into Zeek</h3>
      </html>
    </panel>
  </row>
  <row depends="$cid$">
    <panel>
      <table>
        <search base="CompleteBaseSearch">
          <query>| where like (community_id, $cid|s$)
| eval Time=_time
| appendpipe[| where payload_printable="" | eval payload_printable="No Payload"]
| where !like (payload_printable, "")
| table severity, SID, src_ip, dest_ip, payload_printable, community_id, _time, Time
$HighToLow$
$Formating$</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="link.visible">0</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <format type="color" field="Count">
          <colorPalette type="minMidMax" maxColor="#D41F1F" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <drilldown>
          <set token="basetime">$row.Time$</set>
          <eval token="TimeEarliest">relative_time($basetime$, "-2d")</eval>
          <eval token="TimeLatest">relative_time($basetime$, "+2d")</eval>
          <link target="_blank">search?q=index%3D$zeek|s$%20sourcetype%3D$zeeksourcetype|s$%0A%5B%20search%20index%3D$zeek|s$%20sourcetype%3D$zeekconnsourcetype|s$%20AND%20community_id%3D$cid|s$%0A%7C%20table%20uid%0A%7C%20format%5D%20%0Aearliest%3D$TimeEarliest|s$%20latest%3D$TimeLatest|s$%0A%7C%20sort%20_time&amp;earliest=$TimeEarliest$&amp;latest=$TimeLatest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h3> </h3>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Unknown External To Internal Traffic Triggering Alerts</title>
      <table>
        <option name="link.visible">false</option>
        <title>Select An IP</title>
        <search base="MainBaseSearch">
          <query>$IPEval$
| where like (ExternalSouce, "True") AND !like (ExternalDest, "True")
| stats count by severity, SID, src_ip, dest_ip
$HighToLow$
$Formating$</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <drilldown>
          <set token="ip">$click.value2$</set>
        </drilldown>
      </table>
    </panel>
    <panel>
      <title>Unknown Internal To External Traffic Triggering Alerts</title>
      <table>
        <option name="link.visible">false</option>
        <title>Select An IP</title>
        <search base="MainBaseSearch">
          <query>$IPEval$
| where !like (ExternalSouce, "True") AND like (ExternalDest, "True")
| stats count by severity, SID, src_ip, dest_ip
$HighToLow$
$Formating$</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"High":#D41F1F,"Medium":#D94E17,"Low":#CBA700}</colorPalette>
        </format>
        <drilldown>
          <set token="ip">$click.value2$</set>
        </drilldown>
      </table>
    </panel>
  </row>
</form>
